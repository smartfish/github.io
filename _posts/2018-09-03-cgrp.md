# 资源发布服务

## 功能定义

* 资源以文件方式定义
* 资源文件通过http方式提交
* 资源文件生成对应的bt种子文件
* 种子文件通过http方式下载
* 资源文件通过bt方式下载

## 部署方式

* 定义了两个逻辑服务器，可以合并部署到同一台服务器，也可以分别部署到两台服务器
  * 资源分发服务器
  * 发布通知服务器

* 资源分发服务器 A
  * 种子分发服务
    * [http://A:37220/seeds/](http://A:37220/seeds/)
  * 资源文件上传
    * [http://A:37250/resource/upload](http://A:37250/resource/upload)
  * 资源文件上传查询
    * [http://A:37250/resource/list](http://A:37250/resource/list)
    * [http://A:37250/resource/check](http://A:37250/resource/check)
  * p2p资源文件分发
    * BT/DHT端口: 37240

* 发布通知服务器 B
  * [nats://B:37230](nats://B:37230)
  * 主题: **resource**

## 调用方式

* 资源发布
  * POST方式上传文件到[http://A:37250/resource/upload](http://A:37250/resource/upload)
  * POST参数
    * file
    * md5 *可省略*
    * application *可省略*
    * name *可省略*
    * version *可省略*
    * publisher *可省略*
    * comment *可省略*
  
  * 资源文件名称生成规则
    * 如果application被省略，默认值为default
    * 如果name被省略，则使用file.FileName
    * 如果version被省略，默认值为default
    * 资源文件名称为: application "-" name "-" version

  * 种子文件生成规则
    * 种子文件名称同资源文件名称，后缀为.torrent
    * 如果version不为default，额外生成一个最新版本的种子文件，名称为: application "-" name "-latest"

  * html示例

```` html
<form action="/resource/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file">
    <input type="text" name="md5">
    <input type="text" name="application">
    <input type="text" name="name">
    <input type="text" name="version">
    <input type="text" name="publisher">
    <input type="text" name="comment">
    <input type="submit" value="Submit">
</form>
````

* 资源通知
  * nats客户端订阅[nats://B:37230](nats://B:37230)上的主题**resource**

* 资源下载
  * 通知下载
    1. 订阅[nats://B:37230](nats://B:37230)上的主题**resource**
    2. 通知消息为资源json描述
    3. 通过资源描述生成种子文件名称
    4. 通过[http://A:37220/seeds/](http://A:37220/seeds/)下载种子文件
    5. 使用bt客户端下载
  * 主动下载
    * 根据种子文件生成规则，自行生成最新版本种子文件名称下载

## 场景实例

## 未确定问题

* 安全问题
  * 统一处理？
  * 各个应用自行处理？